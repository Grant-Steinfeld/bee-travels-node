language: node_js

node_js:
  - 10

services:
  - docker

stages:
  - linting
  - testing
  - name: "build-image"
    if: branch = "docker-build"

jobs:
  include:
    - stage: "linting"
      name: "Destination ES Linting"
      script: cd src/destination && npm install && ./node_modules/.bin/eslint src/
    - stage: "linting"
      name: "Hotel Service ES Linting"
      script: cd src/hotel && npm install && ./node_modules/.bin/eslint src/
    - stage: "linting"
      name: "UI client ES Linting"
      script:
        - cd src/ui && npm install && cd ../..
        - cd src/ui/client && npm install && ./node_modules/.bin/eslint src/
    - stage: "testing"
      name: "destination unit test"
      script: cd src/destination && npm install && npm test
    - stage: "testing"
      name: "currency exchange unit test"
      script: cd src/currencyexchange && npm install && npm test
    - stage: "build-image"
      name: "docker image build"
      script: 
        - docker build -t beetravels/destination:$TRAVIS_COMMIT src/destination
        - docker build -t beetravels/hotel:$TRAVIS_COMMIT src/hotel
        - docker build -t beetravels/currencyexchange:$TRAVIS_COMMIT src/currencyexchange
        - docker build -t beetravels/ui:$TRAVIS_COMMIT src/ui
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push beetravels/destination:$TRAVIS_COMMIT
        - docker push beetravels/hotel:$TRAVIS_COMMIT
        - docker push beetravels/currencyexchange:$TRAVIS_COMMIT
        - docker push beetravels/ui:$TRAVIS_COMMIT
after_success:
  - docker images